import{_ as ze,a,D as Te,o as Be,u as Se,x as Pe,c as l,g as r,b as e,w as he,v as _e,F as te,e as se,n as b,i as K,t as f,G as pe,p as He,k as Oe,l as i,j as fe}from"./index-DDlqzt3H.js";import{a as $e,b as je,v as oe}from"./services-GkRl5Aq9.js";import{u as me}from"./oss-BBVvcpXL.js";import{s as u,a as Fe,h as J}from"./toast-hozt1mdT.js";import"./request-CIZjav-Z.js";const c=$=>(He("data-v-15cfdf10"),$=$(),Oe(),$),Ee={key:0,class:"nav-bar"},Ne=c(()=>e("span",{class:"back-arrow"},"❮",-1)),De=[Ne],qe=c(()=>e("div",{class:"title"},"视频合成",-1)),Ge=c(()=>e("span",{class:"back-arrow"},"❮",-1)),Je=[Ge],Ke=c(()=>e("div",{class:"header-title"},"合成视频",-1)),Qe=c(()=>e("div",{class:"placeholder-div"},null,-1)),We={class:"title-input-box"},Xe=c(()=>e("div",{class:"title-input-label"},"作品名称",-1)),Ye=c(()=>e("div",{class:"section-title"},"请选择形象",-1)),Ze={class:"video-cards"},et=["onClick"],tt=["src","alt"],st={key:0,class:"video-text"},ot=c(()=>e("div",{class:"indicator-circle"},null,-1)),at=[ot],lt={key:0,class:"empty-tip"},it={class:"drive-options"},nt={key:1,class:"text-drive-area"},ct={class:"text-footer"},ut=c(()=>e("span",{class:"voice-icon"},"🔊",-1)),dt={class:"text-count"},rt=c(()=>e("button",{class:"btn-write"},[e("span",{class:"write-icon"},"📝"),K(" 写文案 ")],-1)),vt={key:2,class:"voice-record-area"},ht={class:"voice-section"},_t={class:"record-section"},pt=c(()=>e("div",{class:"record-title"},"语音驱动",-1)),ft={key:0,class:"record-tip"},mt=c(()=>e("span",{class:"highlight"},"15~60秒",-1)),gt={key:1,class:"record-tip"},wt={class:"record-controls"},yt=c(()=>e("div",{class:"record-btn-large"},[e("div",{class:"mic-icon"},"🎤")],-1)),kt={key:0,class:"record-progress",width:"90",height:"90"},xt=["stroke-dashoffset"],bt={key:2,class:"record-time"},Ct=c(()=>e("div",{class:"upload-icon-small"},[e("span",{class:"plus-icon-small"},"+")],-1)),Vt=c(()=>e("div",{class:"upload-text-small"},"上传音频文件",-1)),Ut=[Ct,Vt],At={key:4,class:"audio-tip"},Rt={key:5,class:"audio-player"},Mt={key:0},It={class:"audio-controls"},Lt={key:0,xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 24 24",fill:"currentColor",width:"24",height:"24"},zt=c(()=>e("path",{d:"M8 5v14l11-7z"},null,-1)),Tt=[zt],Bt={key:1,xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 24 24",fill:"currentColor",width:"24",height:"24"},St=c(()=>e("path",{d:"M6 19h4V5H6v14zm8-14v14h4V5h-4z"},null,-1)),Pt=[St],Ht={class:"audio-progress-container"},Ot={class:"audio-progress-bar"},$t={class:"audio-time"},jt=c(()=>e("svg",{xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 24 24",fill:"currentColor",width:"20",height:"20"},[e("path",{d:"M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"})],-1)),Ft=[jt],Et={key:1},Nt={class:"audio-file-info"},Dt=c(()=>e("div",{class:"audio-file-icon"},[e("svg",{xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 24 24",fill:"currentColor",width:"24",height:"24"},[e("path",{d:"M12 3v9.28c-.47-.17-.97-.28-1.5-.28C8.01 12 6 14.01 6 16.5S8.01 21 10.5 21c2.31 0 4.2-1.75 4.45-4H15V6h4V3h-7z"})])],-1)),qt={class:"audio-file-name"},Gt={class:"audio-controls"},Jt={key:0,xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 24 24",fill:"currentColor",width:"24",height:"24"},Kt=c(()=>e("path",{d:"M8 5v14l11-7z"},null,-1)),Qt=[Kt],Wt={key:1,xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 24 24",fill:"currentColor",width:"24",height:"24"},Xt=c(()=>e("path",{d:"M6 19h4V5H6v14zm8-14v14h4V5h-4z"},null,-1)),Yt=[Xt],Zt={class:"audio-progress-container"},es={class:"audio-progress-bar"},ts={class:"audio-time"},ss=c(()=>e("svg",{xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 24 24",fill:"currentColor",width:"20",height:"20"},[e("path",{d:"M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"})],-1)),os=[ss],as={key:3,class:"voice-modal"},ls={class:"voice-modal-content"},is=c(()=>e("text",{class:"voice-modal-title"},"选择音色",-1)),ns=c(()=>e("svg",{xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 24 24",fill:"currentColor",width:"24",height:"24"},[e("path",{d:"M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"})],-1)),cs=[ns],us={class:"voice-tabs"},ds={class:"voice-list-container"},rs={key:0,class:"voice-list"},vs=["onClick"],hs={class:"voice-indicator"},_s={key:0,class:"indicator-dot"},ps={class:"voice-info"},fs={class:"voice-name"},ms=["onClick"],gs={key:0,xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 24 24",fill:"currentColor",width:"24",height:"24"},ws=c(()=>e("path",{d:"M8 5v14l11-7z"},null,-1)),ys=[ws],ks={key:1,xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 24 24",fill:"currentColor",width:"24",height:"24"},xs=c(()=>e("path",{d:"M6 19h4V5H6v14zm8-14v14h4V5h-4z"},null,-1)),bs=[xs],Cs={key:1,class:"voice-list"},Vs=["onClick"],Us={class:"voice-indicator"},As={key:0,class:"indicator-dot"},Rs={class:"voice-info"},Ms={class:"voice-name"},Is=["onClick"],Ls={key:0,xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 24 24",fill:"currentColor",width:"24",height:"24"},zs=c(()=>e("path",{d:"M8 5v14l11-7z"},null,-1)),Ts=[zs],Bs={key:1,xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 24 24",fill:"currentColor",width:"24",height:"24"},Ss=c(()=>e("path",{d:"M6 19h4V5H6v14zm8-14v14h4V5h-4z"},null,-1)),Ps=[Ss],Hs={class:"voice-modal-footer"},ge=60,Os={__name:"synthesis",setup($){const we=Pe(),I=Se(),Q=a(!0),U=a([]),A=a(0),ae=a(!1),j=a(""),m=a("text"),L=a(""),g=a(!1),F=a(!1),R=a(0),le=a(null),_=a(!1),E=a(0),z=a(0),N=a(0),w=a(!1),p=a(null),V=a(null),T=a(null),B=a(null),W=a(!1),M=a("system"),S=a([]),D=a([]),v=a(null),ie=a(""),y=a(null),C=a(null),d=a(null),q=a(0),P=a(0),G=a(0),k=a(!1),h=a(null);a("recorded");const ye=Te(()=>{const t=2*Math.PI*40,o=R.value/ge;return t*(1-o)}),H=t=>{if(t==null||isNaN(t))return"00:00";const o=Math.floor(t/60),s=Math.floor(t%60);return`${o.toString().padStart(2,"0")}:${s.toString().padStart(2,"0")}`},ke=async()=>{ae.value=!0;try{const t=await $e.getMyList();U.value=t||[],U.value.length>0&&(A.value=0)}catch(t){console.error("获取形象列表失败:",t)}finally{ae.value=!1}},xe=t=>{A.value=t},ne=()=>{I.back()},be=()=>{!g.value&&!F.value?ce():g.value?ue():F.value&&Ce()},ce=async()=>{try{_.value&&X(),d.value&&Y();const t=await navigator.mediaDevices.getUserMedia({audio:!0});V.value=new MediaRecorder(t);const o=[];V.value.ondataavailable=s=>{o.push(s.data)},V.value.onstop=()=>{const s=[...o];T.value=new Blob(s,{type:"audio/webm"}),B.value=URL.createObjectURL(T.value);const n=new Audio(B.value);n.onloadedmetadata=()=>{E.value=n.duration},_.value=!0,p.value=n},V.value.start(),g.value=!0,R.value=0,le.value=setInterval(()=>{R.value++,R.value>=ge&&ue()},1e3)}catch(t){console.error("录音失败:",t),u({title:"无法访问麦克风",icon:"none"})}},ue=()=>{var t;V.value&&g.value&&(V.value.stop(),clearInterval(le.value),g.value=!1,F.value=!0,(t=V.value.stream)==null||t.getTracks().forEach(o=>o.stop()))},Ce=()=>{ce()},X=()=>{w.value&&p.value&&(p.value.pause(),w.value=!1),B.value&&URL.revokeObjectURL(B.value),_.value=!1,R.value=0,T.value=null,B.value=null,p.value=null,z.value=0,E.value=0,N.value=0},Ve=()=>{if(p.value)if(w.value)p.value.pause(),w.value=!1;else{k.value&&h.value&&(h.value.pause(),k.value=!1),p.value.currentTime=0,p.value.play(),w.value=!0;const t=()=>{w.value&&(z.value=p.value.currentTime,N.value=z.value/E.value*100,requestAnimationFrame(t))};t(),p.value.onended=()=>{w.value=!1,z.value=0,N.value=0}}},Ue=()=>{const t=document.createElement("input");t.type="file",t.accept="audio/*",t.onchange=o=>{const s=o.target.files[0];if(!s)return;if(s.size>20*1024*1024){u({title:"文件大小不能超过20MB",icon:"none"});return}const n=new Audio;n.src=URL.createObjectURL(s),n.onloadedmetadata=()=>{if(n.duration>3*60){URL.revokeObjectURL(n.src),u({title:"音频时长不能超过3分钟",icon:"none"});return}d.value&&h.value&&Y(),_.value&&X(),d.value={file:s,name:s.name,url:n.src},h.value=n,q.value=n.duration},n.onerror=()=>{URL.revokeObjectURL(n.src),u({title:"音频文件无法播放",icon:"none"})}},t.click()},Ae=()=>{if(h.value)if(k.value)h.value.pause(),k.value=!1;else{w.value&&p.value&&(p.value.pause(),w.value=!1),h.value.currentTime=0,h.value.play(),k.value=!0;const t=()=>{k.value&&(P.value=h.value.currentTime,G.value=P.value/q.value*100,requestAnimationFrame(t))};t(),h.value.onended=()=>{k.value=!1,P.value=0,G.value=0}}},Y=()=>{k.value&&h.value&&h.value.pause(),d.value&&d.value.url&&URL.revokeObjectURL(d.value.url),d.value=null,h.value=null,P.value=0,q.value=0,G.value=0,k.value=!1},de=t=>{v.value=t.voiceId||t.id},Re=()=>{if(!v.value){u({title:"请选择音色",icon:"none"});return}const o=(M.value==="system"?S.value:D.value).find(s=>(s.voiceId||s.id)===v.value);o&&(ie.value=o.name),Z()},re=async t=>{if(y.value===t.voiceId||y.value===t.id&&C.value){C.value.pause(),C.value.currentTime=0,y.value=null;return}try{if(C.value&&(C.value.pause(),C.value.currentTime=0),!t.voiceUrl){console.error("音色没有可播放的URL"),u({title:"无法播放音色示例",icon:"none"});return}C.value=new Audio(t.voiceUrl),y.value=t.voiceId||t.id,await C.value.play(),C.value.onended=()=>{y.value=null}}catch(o){console.error("播放声音失败:",o),u({title:"播放声音失败",icon:"none"}),y.value=null}},Me=async()=>{try{const t=await oe.getFavoriteVoiceList();let o=[];t&&Array.isArray(t)&&(o=t.map(O=>({...O,isFavorite:!0})));const s=await oe.getHotVoiceList();let n=[];s&&Array.isArray(s)&&(n=s);const x=[...o];n.forEach(O=>{x.some(ve=>ve.voiceId===O.voiceId||ve.id===O.voiceId)||x.push(O)}),S.value=x;const ee=await oe.getMyVoiceList();ee&&Array.isArray(ee)&&(D.value=ee)}catch(t){console.error("获取音色列表失败:",t),S.value=[{id:1,name:"温柔女声",voiceUrl:"https://example.com/voice1.mp3"},{id:2,name:"标准男声",voiceUrl:"https://example.com/voice2.mp3"},{id:3,name:"活力女声",voiceUrl:"https://example.com/voice3.mp3"}],D.value=[]}},Ie=async()=>{if(!U.value[A.value]){u({title:"请选择形象",icon:"none"});return}if(!j.value){u({title:"请输入作品名称",icon:"none"});return}if(m.value==="text"){if(!v.value){u({title:"请选择音色",icon:"none"});return}if(!L.value.trim()){u({title:"请输入文案",icon:"none"});return}}else if(m.value==="voice"&&!_.value&&!d.value){u({title:"请录制语音或上传音频文件",icon:"none"});return}try{Fe("视频合成中...");const t=new URLSearchParams;if(t.append("name",j.value),t.append("videoUrl",U.value[A.value].videoUrl),m.value==="text")t.append("text",L.value),t.append("voiceId",v.value),t.append("type","text");else if(m.value==="voice"){if(t.append("type","voice"),_.value&&T.value)try{const n=new File([T.value],"recorded_audio.webm",{type:"audio/webm"}),x=await me(n,"digital-human/audios");t.append("audio",x)}catch(n){console.error("音频上传失败:",n),J(),u({title:"音频上传失败，请重试",icon:"none"});return}else if(d.value)try{const n=await me(d.value.file,"digital-human/audios");t.append("audio",n)}catch(n){console.error("音频上传失败:",n),J(),u({title:"音频上传失败，请重试",icon:"none"});return}}console.log("提交创建请求参数:",Object.fromEntries(t.entries()));const o=await je.generate(t);if(J(),console.log("创建响应类型:",typeof o),console.log("创建响应内容:",JSON.stringify(o)),typeof o=="string"){console.log("收到任务ID:",o),u({title:"视频合成任务已提交",icon:"success"}),setTimeout(()=>{I.push("/pages/works/index")},1500);return}if(o&&o.code===200){u({title:"视频合成任务已提交",icon:"success"}),setTimeout(()=>{I.push("/pages/works/index")},1500);return}let s=!1;o&&(o.success===!0||o.data&&o.data.code===200||o.data&&(typeof o.data=="number"||typeof o.data=="string"))&&(s=!0),s?(u({title:"视频合成任务已提交",icon:"success"}),setTimeout(()=>{I.push("/pages/works/index")},1500)):(console.error("创建失败:",o),u({title:typeof o=="object"&&(o!=null&&o.message)?o.message:"创建失败，请重试",icon:"none"}))}catch(t){console.error("创建错误:",t),J(),u({title:t.message||"创建失败，请重试",icon:"none"})}},Le=()=>{W.value=!0,S.value.length===0&&Me()},Z=()=>{W.value=!1};return Be(()=>{ke();const t=I.options.history.state.back;console.log("来源路径:",t),(t&&(t.includes("/pages/index")||t.includes("/pages/asset")||t.includes("/pages/works")||t.includes("/pages/my"))||we.query.fromHome==="true")&&(Q.value=!1)}),(t,o)=>(i(),l("div",{class:b(["synthesis-page",{"no-nav":!Q.value}])},[Q.value?(i(),l("div",Ee,[e("div",{class:"back-btn",onClick:ne},De),qe])):r("",!0),e("div",{class:"top-header"},[e("div",{class:"back-btn",onClick:ne},Je),Ke,Qe]),e("div",We,[Xe,he(e("input",{type:"text",placeholder:"请输入作品名称","onUpdate:modelValue":o[0]||(o[0]=s=>j.value=s),class:"title-input"},null,512),[[_e,j.value]])]),Ye,e("div",Ze,[(i(!0),l(te,null,se(U.value,(s,n)=>(i(),l("div",{key:s.id,class:b(["video-card",{selected:A.value===n}]),onClick:x=>xe(n)},[e("img",{src:s.coverUrl,alt:s.name,class:"video-cover"},null,8,tt),s.name?(i(),l("div",st,f(s.name),1)):r("",!0),e("div",{class:b(["select-indicator",{active:A.value===n}])},at,2)],10,et))),128)),U.value.length===0?(i(),l("div",lt," 暂无形象，请先创建形象 ")):r("",!0)]),e("div",it,[e("div",{class:b(["drive-option",{active:m.value==="text"}]),onClick:o[1]||(o[1]=s=>m.value="text")}," AI文本驱动 ",2),e("div",{class:b(["drive-option",{active:m.value==="voice"}]),onClick:o[2]||(o[2]=s=>m.value="voice")}," 语音驱动 ",2)]),m.value==="text"?(i(),l("div",nt,[he(e("textarea",{class:"text-area",placeholder:"请输入文案","onUpdate:modelValue":o[3]||(o[3]=s=>L.value=s)},null,512),[[_e,L.value]]),e("div",ct,[e("button",{class:"btn-voice-color",onClick:Le},[ut,K(" "+f(ie.value||"选择音色"),1)]),e("span",dt,f(L.value.length)+"/450",1),rt])])):r("",!0),m.value==="voice"?(i(),l("div",vt,[e("div",ht,[e("div",_t,[pt,!g.value&&!_.value&&!d.value?(i(),l("div",ft,[K(" 点击开始录制语音，建议录制 "),mt,K(" 内 ")])):g.value?(i(),l("div",gt," 正在录制中... ")):r("",!0),e("div",wt,[e("div",{class:"record-btn-container",onClick:be},[yt,g.value||F.value?(i(),l("svg",kt,[e("circle",{cx:"45",cy:"45",r:"40",fill:"none",stroke:"#4e5cff","stroke-width":"3","stroke-dasharray":"251.2","stroke-dashoffset":ye.value,transform:"rotate(-90, 45, 45)"},null,8,xt)])):r("",!0)])]),!_.value&&!d.value?(i(),l("div",bt,f(H(R.value)),1)):r("",!0),!d.value&&!_.value&&!g.value?(i(),l("div",{key:3,class:"upload-option",onClick:Ue},Ut)):r("",!0),!_.value&&!d.value&&!g.value?(i(),l("div",At," 支持mp3、m4a、wav音频文件，请上传3分钟内的音频 ")):r("",!0),_.value||d.value?(i(),l("div",Rt,[_.value?(i(),l("div",Mt,[e("div",It,[e("div",{class:"play-btn",onClick:Ve},[w.value?(i(),l("svg",Bt,Pt)):(i(),l("svg",Lt,Tt))]),e("div",Ht,[e("div",Ot,[e("div",{class:"audio-progress",style:pe({width:N.value+"%"})},null,4)]),e("div",$t,f(H(z.value))+" / "+f(H(E.value||0)),1)]),e("div",{class:"delete-btn",onClick:X},Ft)])])):r("",!0),d.value?(i(),l("div",Et,[e("div",Nt,[Dt,e("div",qt,f(d.value.name),1)]),e("div",Gt,[e("div",{class:"play-btn",onClick:Ae},[k.value?(i(),l("svg",Wt,Yt)):(i(),l("svg",Jt,Qt))]),e("div",Zt,[e("div",es,[e("div",{class:"audio-progress",style:pe({width:G.value+"%"})},null,4)]),e("div",ts,f(H(P.value))+" / "+f(H(q.value||0)),1)]),e("div",{class:"delete-btn",onClick:Y},os)])])):r("",!0)])):r("",!0)])])])):r("",!0),e("div",{class:"create-btn",onClick:Ie},"立即创建"),W.value?(i(),l("div",as,[e("div",{class:"voice-modal-mask",onClick:Z}),e("div",ls,[e("div",{class:"voice-modal-header"},[is,e("div",{class:"voice-modal-close",onClick:Z},cs)]),e("div",us,[e("div",{class:b(["voice-tab",{active:M.value==="system"}]),onClick:o[4]||(o[4]=s=>M.value="system")}," 系统音色 ",2),e("div",{class:b(["voice-tab",{active:M.value==="custom"}]),onClick:o[5]||(o[5]=s=>M.value="custom")}," 自定义音色 ",2)]),e("div",ds,[M.value==="system"?(i(),l("div",rs,[(i(!0),l(te,null,se(S.value,(s,n)=>(i(),l("div",{key:"system-"+s.id,class:b(["voice-option",{selected:v.value===s.voiceId||v.value===s.id}]),onClick:x=>de(s)},[e("div",hs,[v.value===s.voiceId||v.value===s.id?(i(),l("div",_s)):r("",!0)]),e("div",ps,[e("text",fs,f(s.name),1)]),e("div",{class:"voice-play",onClick:fe(x=>re(s),["stop"])},[y.value!==s.voiceId&&y.value!==s.id?(i(),l("svg",gs,ys)):(i(),l("svg",ks,bs))],8,ms)],10,vs))),128))])):(i(),l("div",Cs,[(i(!0),l(te,null,se(D.value,(s,n)=>(i(),l("div",{key:"custom-"+s.id,class:b(["voice-option",{selected:v.value===s.voiceId||v.value===s.id}]),onClick:x=>de(s)},[e("div",Us,[v.value===s.voiceId||v.value===s.id?(i(),l("div",As)):r("",!0)]),e("div",Rs,[e("text",Ms,f(s.name),1)]),e("div",{class:"voice-play",onClick:fe(x=>re(s),["stop"])},[y.value!==s.voiceId&&y.value!==s.id?(i(),l("svg",Ls,Ts)):(i(),l("svg",Bs,Ps))],8,Is)],10,Vs))),128))]))]),e("div",Hs,[e("div",{class:b(["confirm-button",{disabled:!v.value}]),onClick:Re}," 确认 ",2)])])])):r("",!0)],2))}},Ds=ze(Os,[["__scopeId","data-v-15cfdf10"]]);export{Ds as default};
